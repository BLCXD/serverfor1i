name: Minecraft Server Ultra-Frequent Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
    - cron: '55 5 * * *'
    - cron: '50 11 * * *'
    - cron: '45 17 * * *'

jobs:
  minecraft:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y openjdk-17-jre-headless wget unzip jq git

      - name: Download ngrok
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -O ngrok.tgz
          tar -xvzf ngrok.tgz
          sudo mv ngrok /usr/local/bin/ngrok
          ngrok version

      - name: Accept EULA
        run: echo "eula=true" > eula.txt

      - name: Start Minecraft Server
        run: |
          java -Xmx2G -Xms1G -jar server.jar nogui &

      - name: Expose via ngrok
        run: |
          ./ngrok tcp 25565 --log=stdout &
          sleep 10
          echo "Public server URL:"
          curl --silent http://127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url'

      - name: Ultra-Frequent Smart Backups
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          for i in {1..60}; do
            echo "Backup iteration $i"
            git add world
            if ! git diff --cached --quiet; then
              git commit -m "Ultra-frequent backup iteration $i"
              git push
              echo "Backup committed."
            else
              echo "No changes detected. Skipping commit."
            fi
            sleep 60
          done
