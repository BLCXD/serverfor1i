name: Minecraft Server with Playit Tunnel

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: 📦 Checkout repo
        uses: actions/checkout@v4

      - name: ☕ Install Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ⚙️ Setup server directory
        run: |
          mkdir -p server
          cd server
          echo "eula=true" > eula.txt

      - name: 🧱 Download PaperMC
        working-directory: server
        run: |
          curl -o paperclip.jar https://api.papermc.io/v2/projects/paper/versions/1.21.1/builds/100/downloads/paper-1.21.1-100.jar

      - name: 🌐 Download Playit.gg client
        working-directory: server
        run: |
          curl -L https://playit.gg/downloads/playit-linux -o playit-linux
          chmod +x playit-linux

      - name: 🚀 Start Minecraft server
        working-directory: server
        run: |
          nohup java -Xms1G -Xmx2G -jar paperclip.jar nogui &
          sleep 20

      - name: 🌍 Start Playit tunnel
        working-directory: server
        run: |
          ./playit-linux --token ${{ secrets.PLAYIT_TOKEN }} > playit.log 2>&1 &
          sleep 15

      - name: 🔎 Extract Playit public address
        id: get_address
        run: |
          sleep 5
          ADDRESS=$(grep -oE "([a-z0-9-]+\.playit\.gg:[0-9]+)" server/playit.log | head -n 1)
          if [ -z "$ADDRESS" ]; then
            echo "❌ Nie znaleziono adresu tunelu!"
            exit 1
          fi
          echo "🌐 Publiczny adres: $ADDRESS"
          echo "ADDRESS=$ADDRESS" >> $GITHUB_ENV

      - name: 💬 Send to Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"username\": \"Minecraft Server\", \"content\": \"🌍 **Serwer Minecraft jest online!**\nIP: \`${{ env.ADDRESS }}\`\nCzas uruchomienia: $(date '+%H:%M:%S') UTC\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

      - name: 🕹️ Keep alive
        run: sleep 3600
