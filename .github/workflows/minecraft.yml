name: Minecraft Server with Playit.gg (Local)

on:
  schedule:
    - cron: "*/355 * * * *"  # restart co 5 godzin i 55 minut
  workflow_dispatch:          # ręczne uruchomienie

jobs:
  minecraft-server:
    runs-on: ubuntu-latest

    steps:
      # --- KROK 1: Pobranie repozytorium ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- KROK 2: Instalacja Javy 21 ---
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: temurin

      # --- KROK 3: Instalacja zależności ---
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y jq curl unzip tar

      # --- KROK 4: Pobranie najnowszego PaperMC ---
      - name: Download PaperMC
        run: |
          mkdir -p server
          cd server
          VERSION=$(curl -s https://api.papermc.io/v2/projects/paper | jq -r '.versions[-1]')
          BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds | jq -r '.builds[-1].build')
          URL="https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"
          curl -sSL "$URL" -o server.jar
          echo "eula=true" > eula.txt
          echo "PaperMC version $VERSION build $BUILD downloaded."

      # --- KROK 5: Przywracanie świata z backupu (jeśli istnieje) ---
      - name: Restore world backup
        run: |
          cd server
          if [ -f ../world-backup.tar.gz ]; then
            echo "Restoring world from previous backup..."
            tar -xzf ../world-backup.tar.gz
          fi

      # --- KROK 6: Uruchomienie serwera Minecraft ---
      - name: Start Minecraft server
        run: |
          cd server
          java -Xmx2G -Xms1G -jar server.jar nogui &
          sleep 10
          echo "Minecraft server started successfully."

      # --- KROK 7: Uruchomienie klienta Playit.gg (lokalnie z repo) ---
      - name: Start Playit.gg tunnel
        run: |
          chmod +x server/playit
          mv server/playit /usr/local/bin/playit
          playit connect --token ${{ secrets.PLAYIT_TOKEN }} &
          sleep 10
          echo "Playit.gg tunnel started. Check logs below for public address."

      # --- KROK 8: Automatyczny backup świata co minutę ---
      - name: Continuous backup every minute
        run: |
          cd server
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"

          bash -c '
          for i in {1..350}; do
            if [ -d world ]; then
              tar -czf ../world-backup.tar.gz world
              git add ../world-backup.tar.gz
              if ! git diff --cached --quiet; then
                git commit -m "Auto backup iteration $i"
                git push || true
                echo "Backup $i committed and pushed."
              else
                echo "No changes detected for iteration $i."
              fi
            fi
            sleep 60
          done
          '
