name: Minecraft Server Continuous Backup

on:
  schedule:
    - cron: "*/355 * * * *"  # restart co 5 godzin 55 minut
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- NGROK ---
      - name: Install dependencies and download ngrok v3
        run: |
          sudo apt update
          sudo apt install -y curl unzip jq
          curl -sSL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok
          ngrok version

      - name: Authenticate ngrok
        run: |
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      # --- PAPERMC SERVER ---
      - name: Download PaperMC
        run: |
          mkdir -p server
          cd server
          PAPER_BUILD=$(curl -s https://api.papermc.io/v2/projects/paper | jq -r '.versions[-1]')
          LATEST_BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$PAPER_BUILD/builds | jq -r '.builds[-1].build')
          DOWNLOAD_URL="https://api.papermc.io/v2/projects/paper/versions/$PAPER_BUILD/builds/$LATEST_BUILD/downloads/paper-$PAPER_BUILD-$LATEST_BUILD.jar"
          curl -sSL "$DOWNLOAD_URL" -o server.jar
          echo "eula=true" > eula.txt

      # --- RESTORE WORLD ---
      - name: Restore world from backup
        run: |
          cd server
          if [ -f ../world-backup.tar.gz ]; then
            echo "Restoring world from backup..."
            tar -xzf ../world-backup.tar.gz
          fi

      # --- START SERVER + NGROK ---
      - name: Start Minecraft Server with ngrok
        run: |
          cd server
          java -Xmx2G -Xms1G -jar server.jar nogui &
          sleep 30
          ngrok tcp 25565 --log=stdout > ngrok.log &
          sleep 10
          echo "Public server URL:"
          curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'

      # --- CONTINUOUS BACKUP ---
      - name: Continuous backup every minute
        run: |
          cd server
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"

          for i in {1..350}; do
            if [ -d world ]; then
              tar -czf ../world-backup.tar.gz world
              git add ../world-backup.tar.gz
              if ! git diff --cached --quiet; then
                git commit -m "Auto backup iteration $i"
                git push || true
                echo "Backup $i committed."
              else
                echo "No changes for iteration $i."
              fi
            fi
            sleep 60
          done
