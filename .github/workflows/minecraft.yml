name: Minecraft Server Ultra-Frequent Backup

on:
  schedule:
    - cron: "*/355 * * * *"  # co 5 godzin i 55 minut
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download ngrok (v3)
        run: |
          sudo apt update
          sudo apt install -y jq curl tar unzip
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
          tar -xvzf ngrok.tgz
          sudo mv ngrok /usr/local/bin/

      - name: Start Minecraft Server
        run: |
          mkdir -p world
          echo "eula=true" > eula.txt
          nohup java -Xmx1024M -Xms1024M -jar server.jar nogui &

      - name: Expose via ngrok
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          nohup ngrok tcp 25565 --log=stdout &
          sleep 10
          echo "Public server URL:"
          curl --silent http://127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url'

      - name: Ultra-Frequent Smart Backups
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          for i in {1..60}; do
            echo "Backup iteration $i"
            mkdir -p world
            git add world
            if ! git diff --cached --quiet; then
              git commit -m "Ultra-frequent backup iteration $i"
              git push
              echo "Backup committed."
            else
              echo "No changes detected. Skipping commit."
            fi
            sleep 60
          done
